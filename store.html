<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>المتعة في الطريق - لوحة الإدارة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --main: #d35400;
      --main-dark: #b03a00;
      --bg: #fff7ec;
      --card: #ffffff;
      --accent: #ffcc80;
      --danger: #d32f2f;
      --ok: #2e7d32;
      --text-main: #3e2723;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Cairo",system-ui,Arial;
      background:linear-gradient(135deg,var(--bg),#ffe0b2);
      color:var(--text-main);
    }
    header{
      padding:.9rem 1rem;
      background:var(--main);
      color:#fff;
      text-align:center;
      position:sticky;
      top:0;
      z-index:10;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      font-size:1.1rem;
      font-weight:600;
    }
    header .sub{
      font-size:.8rem;
      opacity:.9;
      margin-top:.15rem;
    }
    main{
      max-width:520px;
      margin:0 auto;
      padding:1rem;
    }
    .card{
      background:var(--card);
      border-radius:14px;
      padding:1rem 1.2rem;
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      margin-bottom:1rem;
    }
    h2,h3,h4{margin:.2rem 0 .5rem;}
    label{display:block;margin-top:.4rem;font-size:.9rem;}
    input,button,select{
      width:100%;
      padding:.65rem .8rem;
      margin-top:.3rem;
      border-radius:999px;
      border:1px solid #ffddb0;
      font-family:inherit;
      font-size:.9rem;
      outline:none;
    }
    input:focus,select:focus{
      border-color:var(--main);
      box-shadow:0 0 0 2px rgba(211,84,0,.15);
    }
    button{
      background:var(--main);
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:600;
    }
    button:disabled{
      opacity:.5;
      cursor:default;
    }
    button.secondary{
      background:#ffcc80;
      color:#4e342e;
    }
    button.small{
      width:auto;
      padding:.3rem .7rem;
      font-size:.75rem;
      border-radius:999px;
      margin-inline-start:.25rem;
    }
    .error{color:var(--danger);font-size:.85rem;margin-top:.2rem;}
    .success{color:var(--ok);font-size:.85rem;margin-top:.2rem;}

    nav{
      display:flex;
      gap:.3rem;
      margin-bottom:.7rem;
      flex-wrap:wrap;
    }
    nav button{
      flex:1;
      font-size:.8rem;
    }

    ul{list-style:none;padding:0;margin:0;}
    li{
      background:#fff8e1;
      border-radius:10px;
      padding:.6rem .7rem;
      margin-bottom:.4rem;
      font-size:.85rem;
    }
    .tag{
      display:inline-block;
      padding:.1rem .5rem;
      border-radius:999px;
      font-size:.7rem;
      margin-inline-start:.25rem;
    }
    .tag-status{background:#ffe0b2;color:#4e342e;}
    .tag-role{background:#e1f5fe;color:#01579b;}
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.5rem;
    }
    .small{font-size:.8rem;color:#6d4c41;}
    .section-title{
      font-size:.95rem;
      font-weight:600;
      margin:.4rem 0;
    }
    .pill-group{
      display:flex;
      gap:.3rem;
      flex-wrap:wrap;
      margin-top:.35rem;
    }
    .pill{
      padding:.15rem .7rem;
      border-radius:999px;
      border:1px solid #ffcc80;
      font-size:.75rem;
      cursor:pointer;
      background:#fffaf0;
    }
    .pill.active{
      background:var(--main);
      color:#fff;
      border-color:var(--main-dark);
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  المتعة في الطريق
  <div class="sub">لوحة المحل / المندوب / الأدمن - مع الأنواع ورسوم الخدمة</div>
</header>

<main>

  <!-- تسجيل / دخول -->
  <section id="authCard" class="card">
    <h2>تسجيل دخول الإدارة</h2>
    <p class="small">ادخل بياناتك واختر نوع الحساب.</p>
    <label>البريد الإلكتروني</label>
    <input type="email" id="email" placeholder="store@mail.com / driver@mail.com / admin@mail.com" />
    <label>كلمة المرور</label>
    <input type="password" id="password" placeholder="••••••••" />
    <label>نوع الحساب</label>
    <select id="roleSelect">
      <option value="">اختر الدور</option>
      <option value="store">صاحب محل</option>
      <option value="driver">مندوب</option>
      <option value="admin">أدمن</option>
    </select>
    <button id="btnAuth">دخول / إنشاء حساب</button>
    <div id="authMsg" class="error"></div>
  </section>

  <!-- لوحة التطبيق بعد الدخول -->
  <section id="appCard" class="card" style="display:none;">
    <div class="row">
      <div>
        <div class="section-title" id="welcomeTitle">مرحباً</div>
        <div class="small" id="welcomeSub"></div>
      </div>
      <button id="btnLogout" class="small secondary">تسجيل الخروج</button>
    </div>

    <!-- شريط التبويبات -->
    <nav id="navBar" style="display:none;">
      <button id="tabStoreOrders">طلبات المحل</button>
      <button id="tabStoreMenu">قائمة المنتجات</button>
      <button id="tabDrivers">المندوبون</button>
      <button id="tabDriverOrders">لوحة المندوب</button>
      <button id="tabAdmin">لوحة الأدمن</button>
    </nav>

    <!-- محتوى المحل: الطلبات -->
    <div id="storeOrdersSection" style="display:none;margin-top:.3rem;">
      <div class="section-title">طلبات العملاء</div>
      <ul id="storeOrdersList"></ul>
    </div>

    <!-- محتوى المحل: قائمة المنتجات (مشروبات / مخبوزات / ماركت) -->
    <div id="storeMenuSection" style="display:none;margin-top:.3rem;">
      <div class="section-title">نوع خدمة المحل</div>
      <div class="pill-group" id="storeTypePills">
        <div class="pill" data-type="drinks">مشروبات</div>
        <div class="pill" data-type="bakery">مخبوزات</div>
        <div class="pill" data-type="market">ماركت</div>
      </div>

      <label style="margin-top:.6rem;">اسم المنتج</label>
      <input type="text" id="drinkName" placeholder="مثال: كابتشينو / كرواسون / شوكولاتة" />
      <label>سعر المحل (جنيه)</label>
      <input type="number" id="drinkPrice" min="0" placeholder="مثال: 30" />
      <button id="btnAddDrink">إضافة منتج</button>
      <div id="drinkMsg" class="success"></div>
      <h4 style="margin-top:.7rem;">المنتجات الحالية</h4>
      <ul id="drinkList"></ul>
    </div>

    <!-- محتوى المحل: إدارة المندوبين -->
    <div id="driversSection" style="display:none;margin-top:.3rem;">
      <div class="section-title">طلبات الانضمام من المندوبين</div>
      <ul id="driverRequestsList"></ul>
      <div class="section-title">المندوبون المعتمدون</div>
      <ul id="approvedDriversList"></ul>
    </div>

    <!-- محتوى المندوب -->
    <div id="driverPanelSection" style="display:none;margin-top:.3rem;">
      <div class="section-title">ربط مع محل</div>
      <label>اختر محل تريد العمل معه</label>
      <select id="storesSelect"></select>
      <button id="btnRequestLink">طلب موافقة من المحل</button>
      <div id="driverLinkMsg" class="success"></div>

      <h4 style="margin-top:.7rem;">حالة الربط</h4>
      <ul id="driverLinksList"></ul>

      <h4 style="margin-top:.7rem;">طلباتي للتوصيل</h4>
      <ul id="driverOrdersList"></ul>
    </div>

    <!-- لوحة الأدمن -->
    <div id="adminSection" style="display:none;margin-top:.3rem;">
      <div class="section-title">إدارة المحلات</div>
      <ul id="adminStoresList"></ul>

      <div class="section-title" style="margin-top:.8rem;">إدارة المندوبين</div>
      <ul id="adminDriversList"></ul>

      <div class="section-title" style="margin-top:.8rem;">إدارة الطلبات (آخر 30 طلب)</div>
      <ul id="adminOrdersList"></ul>

      <div class="section-title" style="margin-top:.8rem;">إعداد رسوم الخدمة لكل نوع</div>
      <p class="small">هذه الرسوم ستُستخدم في تطبيق العميل لكل نوع خدمة.</p>
      <label>رسوم خدمة المشروبات (feeDrinks)</label>
      <input type="number" id="feeDrinks" min="0" placeholder="مثال: 5" />
      <label>رسوم خدمة المخبوزات (feeBakery)</label>
      <input type="number" id="feeBakery" min="0" placeholder="مثال: 3" />
      <label>رسوم خدمة الماركت (feeMarket)</label>
      <input type="number" id="feeMarket" min="0" placeholder="مثال: 7" />
      <button id="btnSaveFees">حفظ رسوم الخدمة</button>
      <div id="feesMsg" class="success"></div>

      <div class="section-title" style="margin-top:.8rem;">إضافة مشروب/منتج مجاني لعميل</div>
      <label>معرف العميل (customerId)</label>
      <input type="text" id="freeCustomerId" placeholder="uid العميل (مؤقتاً)" />
      <label>معرف المحل (storeId)</label>
      <input type="text" id="freeStoreId" placeholder="storeId المستهدف" />
      <label>معرف المنتج (اختياري - drinkId)</label>
      <input type="text" id="freeDrinkId" placeholder="إن تركته فارغاً، تطبق على أي منتج بحد سعر" />
      <label>أقصى سعر أساسي للمنتج (اختياري)</label>
      <input type="number" id="freeMaxBase" min="0" placeholder="مثال: 30" />
      <button id="btnAddFreeDrink">إضافة هدية للعميل</button>
      <div id="freeDrinkMsg" class="success"></div>
    </div>

  </section>
</main>

<script>
  // 1) إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDatQR-gj_0D49LjQzcFQyn9zAmLd86NJs",
    authDomain: "hotspot-5525c.firebaseapp.com",
    projectId: "hotspot-5525c",
    storageBucket: "hotspot-5525c.firebasestorage.app",
    messagingSenderId: "499759771170",
    appId: "1:499759771170:web:aee6cf7965f7cc374ca47b",
    measurementId: "G-QBH7S7VEJK"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // 2) عناصر الواجهة
  const authCard = document.getElementById('authCard');
  const appCard  = document.getElementById('appCard');
  const emailInput = document.getElementById('email');
  const passInput  = document.getElementById('password');
  const roleSelect = document.getElementById('roleSelect');
  const btnAuth    = document.getElementById('btnAuth');
  const authMsg    = document.getElementById('authMsg');
  const btnLogout  = document.getElementById('btnLogout');

  const welcomeTitle = document.getElementById('welcomeTitle');
  const welcomeSub   = document.getElementById('welcomeSub');
  const navBar       = document.getElementById('navBar');

  const tabStoreOrders  = document.getElementById('tabStoreOrders');
  const tabStoreMenu    = document.getElementById('tabStoreMenu');
  const tabDrivers      = document.getElementById('tabDrivers');
  const tabDriverOrders = document.getElementById('tabDriverOrders');
  const tabAdmin        = document.getElementById('tabAdmin');

  const storeOrdersSection = document.getElementById('storeOrdersSection');
  const storeOrdersList    = document.getElementById('storeOrdersList');

  const storeMenuSection = document.getElementById('storeMenuSection');
  const drinkName        = document.getElementById('drinkName');
  const drinkPrice       = document.getElementById('drinkPrice');
  const btnAddDrink      = document.getElementById('btnAddDrink');
  const drinkMsg         = document.getElementById('drinkMsg');
  const drinkList        = document.getElementById('drinkList');
  const storeTypePills   = document.getElementById('storeTypePills');

  const driversSection       = document.getElementById('driversSection');
  const driverRequestsList   = document.getElementById('driverRequestsList');
  const approvedDriversList  = document.getElementById('approvedDriversList');

  const driverPanelSection = document.getElementById('driverPanelSection');
  const storesSelect       = document.getElementById('storesSelect');
  const btnRequestLink     = document.getElementById('btnRequestLink');
  const driverLinkMsg      = document.getElementById('driverLinkMsg');
  const driverLinksList    = document.getElementById('driverLinksList');
  const driverOrdersList   = document.getElementById('driverOrdersList');

  const adminSection      = document.getElementById('adminSection');
  const adminStoresList   = document.getElementById('adminStoresList');
  const adminDriversList  = document.getElementById('adminDriversList');
  const adminOrdersList   = document.getElementById('adminOrdersList');
  const feeDrinksInput    = document.getElementById('feeDrinks');
  const feeBakeryInput    = document.getElementById('feeBakery');
  const feeMarketInput    = document.getElementById('feeMarket');
  const btnSaveFees       = document.getElementById('btnSaveFees');
  const feesMsg           = document.getElementById('feesMsg');

  const freeCustomerId    = document.getElementById('freeCustomerId');
  const freeStoreId       = document.getElementById('freeStoreId');
  const freeDrinkId       = document.getElementById('freeDrinkId');
  const freeMaxBase       = document.getElementById('freeMaxBase');
  const btnAddFreeDrink   = document.getElementById('btnAddFreeDrink');
  const freeDrinkMsg      = document.getElementById('freeDrinkMsg');

  let currentUser = null;
  let userDoc     = null;
  let userRole    = null;
  let storeDocId  = null;
  let storeDocRef = null;
  let storeType   = 'drinks'; // default

  // 3) دخول / إنشاء حساب
  btnAuth.onclick = async () => {
    authMsg.textContent = '';
    const email = emailInput.value.trim();
    const pass  = passInput.value.trim();
    const role  = roleSelect.value;
    if(!email || !pass || !role){
      authMsg.textContent = 'من فضلك أدخل البريد، كلمة المرور، واختر نوع الحساب.';
      return;
    }
    try{
      const cred = await auth.signInWithEmailAndPassword(email,pass);
      currentUser = cred.user;
      await ensureUserDoc(role, email);
      await loadUserAndInit();
    }catch(e){
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pass);
        currentUser = cred.user;
        await db.collection('users').doc(currentUser.uid).set({
          role,
          email,
          name:'',
          phone:'',
          carNumber:'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        await loadUserAndInit();
      }catch(err){
        authMsg.textContent = err.message;
      }
    }
  };

  auth.onAuthStateChanged(async user=>{
    if(user){
      currentUser = user;
      await loadUserAndInit();
    }
  });

  async function ensureUserDoc(role, email){
    const ref = db.collection('users').doc(currentUser.uid);
    const snap = await ref.get();
    if(!snap.exists){
      await ref.set({
        role,
        email,
        name:'',
        phone:'',
        carNumber:'',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    }
  }

  async function loadUserAndInit(){
    const snap = await db.collection('users').doc(currentUser.uid).get();
    userDoc = snap.data();
    userRole = userDoc.role;
    authCard.style.display = 'none';
    appCard.style.display  = 'block';
    navBar.style.display   = 'flex';

    // إخفاء كل التبويبات مبدئياً
    tabStoreOrders.style.display  = 'none';
    tabStoreMenu.style.display    = 'none';
    tabDrivers.style.display      = 'none';
    tabDriverOrders.style.display = 'none';
    tabAdmin.style.display        = 'none';

    if(userRole === 'store'){
      welcomeTitle.textContent = 'لوحة المحل';
      welcomeSub.textContent   = userDoc.name || userDoc.email;
      tabStoreOrders.style.display  = 'inline-block';
      tabStoreMenu.style.display    = 'inline-block';
      tabDrivers.style.display      = 'inline-block';
      await findOrCreateStoreForOwner();
      setupStoreTypeUI();
      openStoreOrders();
      listenStoreOrders();
      loadStoreDrinks();
      listenDriverLinksForStore();
    }else if(userRole === 'driver'){
      welcomeTitle.textContent = 'لوحة المندوب';
      welcomeSub.textContent   = userDoc.name || userDoc.email;
      tabDriverOrders.style.display = 'inline-block';
      openDriverPanel();
      loadStoresForDriver();
      listenDriverLinksForDriver();
      listenDriverOrders();
    }else if(userRole === 'admin'){
      welcomeTitle.textContent = 'لوحة الأدمن';
      welcomeSub.textContent   = userDoc.email;
      tabAdmin.style.display   = 'inline-block';
      openAdminSection();
      loadAdminData();
      loadServiceFees();
    }
  }

  btnLogout.onclick = async ()=>{
    await auth.signOut();
    location.reload();
  };

  // 4) ربط صاحب المحل بوثيقة store + تحديد نوع المحل
  async function findOrCreateStoreForOwner(){
    const snap = await db.collection('stores')
      .where('ownerId','==',currentUser.uid)
      .limit(1).get();
    if(snap.empty){
      const name = prompt('اكتب اسم المحل للتسجيل أول مرة:','كوفي ستاند');
      // اختيار نوع مبدئي للمحل
      const typePrompt = prompt('اكتب نوع المحل: drinks / bakery / market','drinks');
      const finalType = ['drinks','bakery','market'].includes((typePrompt||'').trim()) ? typePrompt.trim() : 'drinks';
      const ref = await db.collection('stores').add({
        ownerId: currentUser.uid,
        name: name || 'محل بدون اسم',
        address: '',
        isActive: true,
        location: null,
        storeType: finalType
      });
      storeDocId  = ref.id;
      storeDocRef = ref;
      storeType   = finalType;
    }else{
      storeDocId  = snap.docs[0].id;
      storeDocRef = snap.docs[0].ref;
      const data  = snap.docs[0].data();
      storeType   = data.storeType || 'drinks';
    }
  }

  // التعامل مع UI اختيار نوع المحل (لصاحب المحل)
  function setupStoreTypeUI(){
    if(!storeDocRef) return;
    [...storeTypePills.children].forEach(p=>{
      const type = p.dataset.type;
      if(type === storeType) p.classList.add('active');
      p.onclick = async ()=>{
        storeType = type;
        [...storeTypePills.children].forEach(x=>x.classList.remove('active'));
        p.classList.add('active');
        // تحديث نوع المحل في Firestore
        await storeDocRef.update({storeType});
      };
    });
  }

  // 5) تبويب التنقّل
  tabStoreOrders.onclick  = openStoreOrders;
  tabStoreMenu.onclick    = openStoreMenu;
  tabDrivers.onclick      = openDriversSection;
  tabDriverOrders.onclick = openDriverPanel;
  tabAdmin.onclick        = openAdminSection;

  function hideAllSections(){
    storeOrdersSection.style.display  = 'none';
    storeMenuSection.style.display    = 'none';
    driversSection.style.display      = 'none';
    driverPanelSection.style.display  = 'none';
    adminSection.style.display        = 'none';
  }
  function openStoreOrders(){ hideAllSections(); if(userRole==='store') storeOrdersSection.style.display = 'block'; }
  function openStoreMenu(){   hideAllSections(); if(userRole==='store') storeMenuSection.style.display = 'block'; }
  function openDriversSection(){ hideAllSections(); if(userRole==='store') driversSection.style.display = 'block'; }
  function openDriverPanel(){ hideAllSections(); if(userRole==='driver') driverPanelSection.style.display = 'block'; }
  function openAdminSection(){ hideAllSections(); if(userRole==='admin') adminSection.style.display = 'block'; }

  // 6) إدارة منتجات المحل (drinks/products)
  btnAddDrink.onclick = async ()=>{
    drinkMsg.textContent = '';
    const name = drinkName.value.trim();
    const price = parseFloat(drinkPrice.value);
    if(!name || isNaN(price)){
      drinkMsg.style.color = '#d32f2f';
      drinkMsg.textContent = 'أدخل اسم وسعر صحيحين.';
      return;
    }
    if(!storeDocId){
      drinkMsg.style.color = '#d32f2f';
      drinkMsg.textContent = 'لم يتم ربط المحل بعد.';
      return;
    }
    try{
      await db.collection('drinks').add({
        storeId: storeDocId,
        name,
        basePrice: price,
        storeType: storeType // مهم للتمييز في تطبيق العميل
      });
      drinkName.value = '';
      drinkPrice.value = '';
      drinkMsg.style.color = '#2e7d32';
      drinkMsg.textContent = 'تم إضافة المنتج.';
      loadStoreDrinks();
    }catch(e){
      drinkMsg.style.color = '#d32f2f';
      drinkMsg.textContent = 'حدث خطأ أثناء الإضافة.';
    }
  };

  async function loadStoreDrinks(){
    if(!storeDocId) return;
    const snap = await db.collection('drinks')
      .where('storeId','==',storeDocId).get();
    drinkList.innerHTML = '';
    if(snap.empty){
      drinkList.innerHTML = '<li class="small">لا توجد منتجات بعد.</li>';
      return;
    }
    snap.forEach(doc=>{
      const d = doc.data();
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="row">
          <div>
            <b>${d.name}</b><br>
            <span class="small">سعر المحل: ${d.basePrice} ج</span><br>
            <span class="small">نوع الخدمة: ${d.storeType || '-'}</span>
          </div>
        </div>
      `;
      drinkList.appendChild(li);
    });
  }

  // 7) طلبات المحل + زر خريطة من المحل للعميل
  function listenStoreOrders(){
    if(!storeDocId) return;
    db.collection('orders')
      .where('storeId','==',storeDocId)
      .orderBy('createdAt','desc')
      .limit(30)
      .onSnapshot(snap=>{
        storeOrdersList.innerHTML = '';
        if(snap.empty){
          storeOrdersList.innerHTML = '<li class="small">لا توجد طلبات حتى الآن.</li>';
          return;
        }
        snap.forEach(doc=>{
          const o = doc.data();
          const drinkName = o.drinkName || (o.items && o.items[0]?.drinkName) || '';
          const price     = o.totalCustomerPrice || (o.items && o.items[0]?.totalItemPrice) || 0;

          const li = document.createElement('li');
          li.innerHTML = `
            <div class="row">
              <div>
                <b>${drinkName}</b>
                <span class="tag tag-status">${o.status}</span><br>
                <span class="small">السعر للعميل: ${price} ج</span><br>
                <span class="small">عربية: ${o.carNumber || '-'}</span><br>
                <button class="small secondary" data-map="open">خريطة للعميل</button>
              </div>
              <div>
                <button class="small" data-action="toPreparing">قيد التحضير</button>
                <button class="small" data-action="toReady">جاهز</button>
                <button class="small secondary" data-action="toDelivered">تم التسليم (بواسطة المحل)</button>
              </div>
            </div>
          `;
          li.querySelectorAll('button').forEach(b=>{
            const act = b.dataset.action;
            const map = b.dataset.map;
            if(map === 'open'){
              b.onclick = ()=>openMapStoreToCustomer(o);
            }else{
              b.onclick = ()=>updateOrderStatusFromStore(doc.id, act);
            }
          });
          storeOrdersList.appendChild(li);
        });
      });
  }

  async function updateOrderStatusFromStore(orderId, action){
    let newStatus = null;
    if(action === 'toPreparing') newStatus = 'preparing';
    if(action === 'toReady')     newStatus = 'ready';
    if(action === 'toDelivered') newStatus = 'delivered';
    if(!newStatus) return;
    await db.collection('orders').doc(orderId).update({ status:newStatus });
  }

  // فتح خريطة من موقع المحل إلى موقع العميل
  function openMapStoreToCustomer(orderData){
    // يفترض أن عندك في الطلب حقول customerLat, customerLng
    // وفي المحل stores.location كـ GeoPoint
    if(!storeDocRef) return;
    storeDocRef.get().then(doc=>{
      const s = doc.data();
      if(!s.location || !orderData.customerLat || !orderData.customerLng){
        alert('موقع المحل أو العميل غير متوفر.');
        return;
      }
      const latStore = s.location.latitude;
      const lngStore = s.location.longitude;
      const latCust  = orderData.customerLat;
      const lngCust  = orderData.customerLng;
      const url = `https://www.google.com/maps/dir/?api=1&origin=${latStore},${lngStore}&destination=${latCust},${lngCust}&travelmode=driving`;
      window.open(url,'_blank');
    });
  }

  // 8) ربط المندوبين بالمحل
  function listenDriverLinksForStore(){
    if(!storeDocId) return;
    db.collection('driverLinks')
      .where('storeId','==',storeDocId)
      .onSnapshot(snap=>{
        driverRequestsList.innerHTML  = '';
        approvedDriversList.innerHTML = '';
        if(snap.empty){
          driverRequestsList.innerHTML = '<li class="small">لا توجد طلبات من مندوبين حالياً.</li>';
          approvedDriversList.innerHTML = '<li class="small">لا توجد موافقات بعد.</li>';
          return;
        }
        snap.forEach(doc=>{
          const link = doc.data();
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="row">
              <div>
                <b>مندوب: ${link.driverId}</b>
                <span class="tag tag-role">${link.approved ? 'معتمد' : 'في الانتظار'}</span>
                <div class="small">storeId: ${link.storeId}</div>
              </div>
              <div>
                ${link.approved ? '' : '<button class="small" data-action="approve">موافقة</button>'}
                <button class="small secondary" data-action="remove">حذف</button>
              </div>
            </div>
          `;
          li.querySelectorAll('button').forEach(b=>{
            b.onclick = ()=>handleDriverLinkAction(doc.id, b.dataset.action);
          });
          if(link.approved){
            approvedDriversList.appendChild(li);
          }else{
            driverRequestsList.appendChild(li);
          }
        });
        if(driverRequestsList.innerHTML === '') driverRequestsList.innerHTML = '<li class="small">لا توجد طلبات حالياً.</li>';
        if(approvedDriversList.innerHTML === '') approvedDriversList.innerHTML = '<li class="small">لا توجد موافقات بعد.</li>';
      });
  }

  async function handleDriverLinkAction(linkId, action){
    const ref = db.collection('driverLinks').doc(linkId);
    if(action === 'approve'){
      await ref.update({ approved:true });
    }else if(action === 'remove'){
      await ref.delete();
    }
  }

  // 9) واجهة المندوب
  async function loadStoresForDriver(){
    const snap = await db.collection('stores').where('isActive','==',true).get();
    storesSelect.innerHTML = '';
    if(snap.empty){
      storesSelect.innerHTML = '<option value="">لا توجد محلات متاحة</option>';
      return;
    }
    storesSelect.innerHTML = '<option value="">اختر محل</option>';
    snap.forEach(d=>{
      const s = d.data();
      const opt = document.createElement('option');
      opt.value = d.id;
      const t = s.storeType === 'bakery' ? ' (مخبوزات)' : (s.storeType === 'market' ? ' (ماركت)' : ' (مشروبات)');
      opt.textContent = (s.name || d.id) + t;
      storesSelect.appendChild(opt);
    });
  }

  btnRequestLink.onclick = async ()=>{
    driverLinkMsg.textContent = '';
    const storeId = storesSelect.value;
    if(!storeId){
      driverLinkMsg.style.color = '#d32f2f';
      driverLinkMsg.textContent = 'اختر محل أولاً.';
      return;
    }
    const snap = await db.collection('driverLinks')
      .where('storeId','==',storeId)
      .where('driverId','==',currentUser.uid)
      .limit(1).get();
    if(!snap.empty){
      driverLinkMsg.style.color = '#d32f2f';
      driverLinkMsg.textContent = 'طلبت العمل مع هذا المحل من قبل.';
      return;
    }
    await db.collection('driverLinks').add({
      storeId,
      driverId: currentUser.uid,
      approved:false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    driverLinkMsg.style.color = '#2e7d32';
    driverLinkMsg.textContent = 'تم إرسال طلب الموافقة لصاحب المحل.';
  };

  function listenDriverLinksForDriver(){
    db.collection('driverLinks')
      .where('driverId','==',currentUser.uid)
      .onSnapshot(snap=>{
        driverLinksList.innerHTML = '';
        if(snap.empty){
          driverLinksList.innerHTML = '<li class="small">لا توجد روابط بعد.</li>';
          return;
        }
        snap.forEach(doc=>{
          const link = doc.data();
          const li = document.createElement('li');
          li.innerHTML = `
            <div>
              <b>محل: ${link.storeId}</b>
              <span class="tag tag-status">${link.approved ? 'معتمد' : 'في الانتظار'}</span>
            </div>
          `;
          driverLinksList.appendChild(li);
        });
      });
  }

  function listenDriverOrders(){
    db.collection('orders')
      .where('driverId','==',currentUser.uid)
      .orderBy('createdAt','desc')
      .limit(30)
      .onSnapshot(snap=>{
        driverOrdersList.innerHTML = '';
        if(snap.empty){
          driverOrdersList.innerHTML = '<li class="small">لا توجد طلبات مخصصة لك حالياً.</li>';
          return;
        }
        snap.forEach(doc=>{
          const o = doc.data();
          const drinkName = o.drinkName || (o.items && o.items[0]?.drinkName) || '';
          const price     = o.totalCustomerPrice || (o.items && o.items[0]?.totalItemPrice) || 0;
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="row">
              <div>
                <b>${drinkName}</b>
                <span class="tag tag-status">${o.status}</span><br>
                <span class="small">سعر للعميل: ${price} ج</span><br>
                <span class="small">عربية: ${o.carNumber || '-'}</span>
              </div>
              <div>
                <button class="small" data-action="toOnTheWay">في الطريق</button>
                <button class="small secondary" data-action="toDelivered">تم التسليم</button>
              </div>
            </div>
          `;
          li.querySelectorAll('button').forEach(b=>{
            b.onclick = ()=>updateOrderStatusFromDriver(doc.id, b.dataset.action);
          });
          driverOrdersList.appendChild(li);
        });
      });
  }

  async function updateOrderStatusFromDriver(orderId, action){
    let newStatus = null;
    if(action === 'toOnTheWay') newStatus = 'on_the_way';
    if(action === 'toDelivered') newStatus = 'delivered';
    if(!newStatus) return;
    await db.collection('orders').doc(orderId).update({ status:newStatus });
  }

  // 10) لوحة الأدمن: تحميل البيانات + إعداد رسوم الخدمة
  async function loadAdminData(){
    // المحلات
    const storesSnap = await db.collection('stores').get();
    adminStoresList.innerHTML = '';
    if(storesSnap.empty){
      adminStoresList.innerHTML = '<li class="small">لا توجد محلات حتى الآن.</li>';
    }else{
      storesSnap.forEach(doc=>{
        const s = doc.data();
        const li = document.createElement('li');
        const typeLabel = s.storeType === 'bakery' ? 'مخبوزات' : (s.storeType === 'market' ? 'ماركت' : 'مشروبات');
        li.innerHTML = `
          <div class="row">
            <div>
              <b>${s.name || 'محل بدون اسم'}</b>
              <span class="tag tag-status">${s.isActive ? 'نشط' : 'موقوف'}</span>
              <span class="tag tag-role">${typeLabel}</span><br>
              <span class="small">ID: ${doc.id}</span><br>
              <span class="small">المالك: ${s.ownerId || '-'}</span>
            </div>
            <div>
              <button class="small" data-action="toggle">${s.isActive ? 'إيقاف' : 'تشغيل'}</button>
            </div>
          </div>
        `;
        li.querySelector('button').onclick = async ()=>{
          const cur = s.isActive;
          try{
            await db.collection('stores').doc(doc.id).update({isActive:!cur});
            loadAdminData();
          }catch(e){
            alert('خطأ في تحديث حالة المحل.');
          }
        };
        adminStoresList.appendChild(li);
      });
    }

    // المندوبون
    const driversSnap = await db.collection('users').where('role','==','driver').get();
    adminDriversList.innerHTML = '';
    if(driversSnap.empty){
      adminDriversList.innerHTML = '<li class="small">لا يوجد مندوبون مسجلون.</li>';
    }else{
      driversSnap.forEach(doc=>{
        const u = doc.data();
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <b>${u.name || u.email}</b>
            <span class="tag tag-role">مندوب</span><br>
            <span class="small">ID: ${doc.id}</span><br>
            <span class="small">هاتف: ${u.phone || '-'}</span>
          </div>
        `;
        adminDriversList.appendChild(li);
      });
    }

    // الطلبات (آخر 30)
    const ordersSnap = await db.collection('orders')
      .orderBy('createdAt','desc')
      .limit(30).get();
    adminOrdersList.innerHTML = '';
    if(ordersSnap.empty){
      adminOrdersList.innerHTML = '<li class="small">لا توجد طلبات بعد.</li>';
    }else{
      ordersSnap.forEach(doc=>{
        const o = doc.data();
        const drinkName = o.drinkName || (o.items && o.items[0]?.drinkName) || '';
        const price     = o.totalCustomerPrice || (o.items && o.items[0]?.totalItemPrice) || 0;
        const li = document.createElement('li');
        li.innerHTML = `
          <div>
            <b>${drinkName}</b>
            <span class="tag tag-status">${o.status}</span><br>
            <span class="small">عميل: ${o.customerId}</span><br>
            <span class="small">محل: ${o.storeId}</span><br>
            <span class="small">مندوب: ${o.driverId || '-'}</span><br>
            <span class="small">سعر للعميل: ${price} ج</span>
          </div>
        `;
        adminOrdersList.appendChild(li);
      });
    }
  }

  // قراءة / حفظ رسوم الخدمة في settings/serviceFees
  async function loadServiceFees(){
    feesMsg.textContent = '';
    try{
      const ref = db.collection('settings').doc('serviceFees');
      const snap = await ref.get();
      if(snap.exists){
        const d = snap.data();
        feeDrinksInput.value = d.feeDrinks != null ? d.feeDrinks : 0;
        feeBakeryInput.value = d.feeBakery != null ? d.feeBakery : 0;
        feeMarketInput.value = d.feeMarket != null ? d.feeMarket : 0;
      }else{
        feeDrinksInput.value = 0;
        feeBakeryInput.value = 0;
        feeMarketInput.value = 0;
      }
    }catch(e){
      feesMsg.style.color = '#d32f2f';
      feesMsg.textContent = 'تعذر تحميل رسوم الخدمة.';
    }
  }

  btnSaveFees.onclick = async ()=>{
    feesMsg.textContent = '';
    const feeDrinks = feeDrinksInput.value ? parseFloat(feeDrinksInput.value) : 0;
    const feeBakery = feeBakeryInput.value ? parseFloat(feeBakeryInput.value) : 0;
    const feeMarket = feeMarketInput.value ? parseFloat(feeMarketInput.value) : 0;
    try{
      await db.collection('settings').doc('serviceFees').set({
        feeDrinks,
        feeBakery,
        feeMarket,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      feesMsg.style.color = '#2e7d32';
      feesMsg.textContent = 'تم حفظ رسوم الخدمة بنجاح.';
    }catch(e){
      feesMsg.style.color = '#d32f2f';
      feesMsg.textContent = 'حدث خطأ أثناء الحفظ.';
    }
  };

  // هدية مجانية
  btnAddFreeDrink.onclick = async ()=>{
    freeDrinkMsg.textContent = '';
    const customerId = freeCustomerId.value.trim();
    const storeId    = freeStoreId.value.trim();
    const drinkId    = freeDrinkId.value.trim() || null;
    const maxBase    = freeMaxBase.value ? parseFloat(freeMaxBase.value) : null;

    if(!customerId || !storeId){
      freeDrinkMsg.style.color = '#d32f2f';
      freeDrinkMsg.textContent = 'معرف العميل ومعرف المحل مطلوبان.';
      return;
    }
    try{
      await db.collection('freeDrinks').add({
        customerId,
        storeId,
        drinkId,
        maxBasePrice: maxBase,
        used:false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        usedAt:null
      });
      freeDrinkMsg.style.color = '#2e7d32';
      freeDrinkMsg.textContent = 'تم إضافة هدية للعميل بنجاح.';
      freeCustomerId.value = '';
      freeStoreId.value = '';
      freeDrinkId.value = '';
      freeMaxBase.value = '';
    }catch(e){
      freeDrinkMsg.style.color = '#d32f2f';
      freeDrinkMsg.textContent = 'حدث خطأ أثناء الإضافة.';
    }
  };
</script>
</body>
  </html>
