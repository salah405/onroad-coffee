<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…ØªØ¹Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* Morning Coffee Theme - ÙØ§ØªØ­ ÙˆÙ…Ù†Ø¹Ø´ */
      --bg: #f7eee2;               /* ÙƒØ±ÙŠÙ…ÙŠ ÙØ§ØªØ­ ÙŠØ´Ø¨Ù‡ Ø±ØºÙˆØ© Ø§Ù„Ù„Ø§ØªÙŠÙ‡ */ 
      --bg-elevated: #ffffff;      /* ÙƒØ±ÙˆØª Ø¨ÙŠØ¶Ø§Ø¡ Ù†Ø¶ÙŠÙØ© */
      --bg-elevated-2: #f3e2c8;    /* ÙƒØ±ÙˆØª Ø«Ø§Ù†ÙˆÙŠØ© Ø¨Ù„ÙˆÙ† Ù‚Ù‡ÙˆØ© Ø®ÙÙŠÙ */
      --border-subtle: #e0d1bc;    /* Ø­Ø¯ÙˆØ¯ Ù†Ø§Ø¹Ù…Ø© Ø¯Ø§ÙØ¦Ø© */
      --text-main: #3b2b24;        /* Ø¨Ù†ÙŠ ØºØ§Ù…Ù‚ Ù…Ø±ÙŠØ­ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© */
      --text-sub: #8b6f55;         /* Ø¨Ù†ÙŠ Ø£ÙØªØ­ Ù„Ù„Ù†ØµÙˆØµ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© */
      --accent: #e69b34;           /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¯Ù‡Ø¨ÙŠ Ø¯Ø§ÙÙŠ (Ù„ÙˆÙ† Ø´Ù…Ø³/Ø¥Ø³Ø¨Ø±ÙŠØ³Ùˆ) */
      --accent-soft: rgba(230,155,52,0.16);
      --danger: #e8504f;
      --success: #2e7d32;
      --shadow-soft: 0 14px 40px rgba(155,118,80,0.25); /* Ø¸Ù„ Ø¯Ø§ÙÙŠ */
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Cairo",system-ui,Arial;
      background:
        radial-gradient(circle at top,#ffe9c3 0,#f7eee2 45%,#f3e2c8 100%);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    header{
      padding:.9rem 1rem;
      background:
        linear-gradient(135deg,#fffbf5,#ffe0b3);
      color:#3b2b24;
      text-align:center;
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:blur(16px);
      border-bottom:1px solid rgba(179,130,65,0.25);
      box-shadow:0 8px 26px rgba(191,140,76,0.35);
    }
    header .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:.75rem;
    }

    /* Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¨Ø§Ù„Ù„ÙˆØ¬Ùˆ Ø§Ù„Ù…Ø±ÙÙ‚ */
    header .logo-icon{
      width:46px;
      height:46px;
      border-radius:18px;
      background:
        #ffffff
        url("logo-coffee.png") center center/cover no-repeat;
      box-shadow:
        0 0 0 1px rgba(255,255,255,0.7),
        0 10px 24px rgba(166,115,52,0.55);
    }

    header .logo-text-main{
      font-weight:800;
      letter-spacing:.04em;
      font-size:1.08rem;
    }
    header .logo-text-sub{
      font-size:.8rem;
      color:var(--text-sub);
    }

    main{
      max-width:480px;
      margin:0 auto;
      padding:1rem .85rem 1.1rem;
    }

    .card{
      background:linear-gradient(
        150deg,
        rgba(255,255,255,0.96),
        rgba(255,245,229,0.92)
      );
      border-radius:20px;
      padding:1rem 1.1rem;
      box-shadow:var(--shadow-soft);
      margin-bottom:1rem;
      border:1px solid var(--border-subtle);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at top right,rgba(255,255,255,0.9),transparent 55%),
        radial-gradient(circle at bottom left,rgba(255,222,173,0.5),transparent 65%);
      opacity:.92;
      pointer-events:none;
    }
    .card > *{position:relative;}

    h2,h3,h4{margin:.2rem 0 .5rem;}
    h2{font-size:1.2rem;}
    h3{font-size:1.05rem;}
    h4{font-size:.98rem;}
    label{display:block;margin-top:.4rem;font-size:.9rem;color:var(--text-sub);}

    input,button,select{
      width:100%;
      padding:.75rem .85rem;
      margin-top:.3rem;
      border-radius:999px;
      border:1px solid var(--border-subtle);
      font-family:inherit;
      font-size:.9rem;
      outline:none;
      background:rgba(255,252,246,0.9);
      color:var(--text-main);
      transition:border-color .18s,box-shadow .18s,background .18s,transform .08s;
    }
    input:focus,select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(230,155,52,0.6);
      background:#fffaf2;
    }

    button{
      background:linear-gradient(140deg,#ffb547,#ff9234);
      color:#3b2b24;
      border:none;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.03em;
      position:relative;
      overflow:hidden;
    }
    button::after{
      content:"";
      position:absolute;
      top:0;left:-40%;
      width:40%;
      height:100%;
      background:linear-gradient(115deg,rgba(255,255,255,0.65),transparent 65%);
      transform:skewX(-20deg) translateX(-120%);
      transition:transform .4s;
      pointer-events:none;
    }
    button:hover::after{
      transform:skewX(-20deg) translateX(260%);
    }
    button:active{
      transform:scale(.97);
      box-shadow:none;
    }
    button:disabled{
      opacity:.55;
      cursor:default;
      background:linear-gradient(140deg,#f0e0c4,#e0c59d);
      color:var(--text-sub);
    }

    button.primary{
      box-shadow:0 12px 26px rgba(202,135,50,0.45);
    }

    .error{color:var(--danger);font-size:.8rem;margin-top:.25rem;}
    .success{color:var(--success);font-size:.8rem;margin-top:.25rem;}

    .small{
      font-size:.8rem;color:var(--text-sub);
    }

    .store-chip{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      padding:.35rem .85rem;
      background:rgba(255,255,255,0.95);
      border-radius:999px;
      font-size:.8rem;
      border:1px solid var(--border-subtle);
      backdrop-filter:blur(10px);
      box-shadow:0 6px 14px rgba(188,137,72,0.25);
    }
    .store-chip span.distance{
      color:var(--accent);font-weight:700;
    }
    .pulse-dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 0 rgba(230,155,52,0.65);
      animation:pulse 1.7s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(230,155,52,0.7);}
      70%{box-shadow:0 0 0 9px rgba(230,155,52,0);}
      100%{box-shadow:0 0 0 0 rgba(230,155,52,0);}
    }

    .store-list{
      display:flex;
      overflow-x:auto;
      gap:.6rem;
      padding-bottom:.45rem;
      margin-top:.5rem;
      scrollbar-width:thin;
      scrollbar-color:#d2b591 transparent;
    }
    .store-list::-webkit-scrollbar{height:4px;}
    .store-list::-webkit-scrollbar-track{background:transparent;}
    .store-list::-webkit-scrollbar-thumb{
      background:#d2b591;
      border-radius:999px;
    }

    .store-card{
      min-width:165px;
      background:linear-gradient(
        145deg,
        #fffdf7,
        #f7e2be
      );
      border-radius:16px;
      padding:.6rem .75rem;
      cursor:pointer;
      border:1px solid rgba(202,161,104,0.35);
      font-size:.85rem;
      flex-shrink:0;
      position:relative;
      overflow:hidden;
      transition:border-color .18s,box-shadow .18s,transform .12s,background .18s;
    }
    .store-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top left,rgba(255,255,255,0.85),transparent 60%);
      opacity:.4;
      transition:opacity .18s;
      pointer-events:none;
    }
    .store-card.active{
      border-color:var(--accent);
      box-shadow:0 14px 32px rgba(181,120,52,0.55);
      transform:translateY(-2px);
      background:linear-gradient(145deg,#fffaf1,#ffd28b);
    }
    .store-card.active::before{opacity:.9;}
    .store-name{font-weight:700;margin-bottom:.2rem;color:var(--text-main);}
    .store-meta{font-size:.78rem;color:var(--text-sub);line-height:1.4;}

    .drink-list{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.65rem;
      margin-top:.55rem;
    }
    .drink-card{
      background:linear-gradient(
        145deg,
        #fffdf8,
        #ffe7c3
      );
      border-radius:16px;
      padding:.6rem .55rem .6rem;
      text-align:center;
      cursor:pointer;
      border:1px solid rgba(214,173,112,0.45);
      position:relative;
      overflow:hidden;
      transition:border-color .18s,box-shadow .18s,transform .1s,background .18s;
    }
    .drink-card::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at top,rgba(255,255,255,0.85),transparent 65%);
      opacity:.0;
      transition:opacity .18s;
      pointer-events:none;
    }
    .drink-card.active{
      border-color:var(--accent);
      box-shadow:0 12px 28px rgba(194,132,59,0.6);
      transform:translateY(-1px);
      background:linear-gradient(145deg,#fff6e5,#ffc773);
    }
    .drink-card.active::before{opacity:1;}
    .drink-name{font-weight:700;font-size:.9rem;color:var(--text-main);}
    .drink-price{font-size:.85rem;color:var(--accent);margin-top:.25rem;}
    .pill{
      display:inline-block;
      padding:.18rem .6rem;
      border-radius:999px;
      font-size:.7rem;
      background:var(--accent-soft);
      color:var(--accent);
      margin-top:.25rem;
      font-weight:600;
    }

    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:.45rem;
      font-size:.9rem;
    }
    .big-price{
      font-size:1.25rem;
      font-weight:800;
      color:var(--accent);
    }

    .status-dot{
      width:11px;height:11px;border-radius:50%;
      background:#e0d1bc;
      display:inline-block;margin-left:.3rem;
      box-shadow:0 0 0 0 rgba(46,125,50,0);
      transition:background .18s,box-shadow .25s;
    }
    .status-dot.active{
      background:var(--success);
      box-shadow:0 0 0 4px rgba(46,125,50,0.22);
    }
    .timeline{
      display:flex;
      justify-content:space-between;
      margin-top:.65rem;
      font-size:.75rem;
      color:var(--text-sub);
    }
    .timeline-step{
      text-align:center;
      flex:1;
    }
    .timeline-step span.label{display:block;margin-top:.22rem;}

    .section-title{
      font-size:.82rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--text-sub);
      margin-bottom:.25rem;
    }

    .badge-soft{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      padding:.18rem .6rem;
      border-radius:999px;
      font-size:.72rem;
      background:rgba(255,214,165,0.45);
      color:#8a5a24;
      font-weight:600;
    }
    .sparkle{
      font-size:.9rem;
    }

    .hint{
      font-size:.78rem;
      color:var(--text-sub);
      margin-top:.15rem;
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div>
      <div class="logo-text-main">Ø§Ù„Ù…ØªØ¹Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</div>
      <div class="logo-text-sub">Ù‚Ù‡ÙˆØªÙƒ ØªØµØ­Ù‘ÙŠÙƒ Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</div>
    </div>
  </div>
</header>

<main>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <section id="authCard" class="card">
    <div class="section-title">Ø­Ø³Ø§Ø¨Ùƒ</div>
    <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ğŸ‘‹</h2>
    <p class="small">Ø³Ø¬Ù‘Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø·Ù„Ø¨Ùƒ ÙŠØªÙ… ÙÙŠ Ø«ÙˆØ§Ù†ÙŠ.</p>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="email" placeholder="example@mail.com" />
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <button id="btnAuth" class="primary">Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <div id="authMsg" class="error"></div>
  </section>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <section id="profileCard" class="card" style="display:none;">
    <div class="section-title">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</div>
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±ØªÙƒ</h3>
    <p class="small">ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‡Ø§ ØªØ§Ù†ÙŠ.</p>
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <input type="text" id="custName" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„" />
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
    <input type="tel" id="custPhone" placeholder="01xxxxxxxxx" />
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
    <input type="text" id="custCar" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¹ 1234" />
    <button id="btnSaveProfile">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="profileMsg" class="success"></div>
  </section>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <section id="orderCard" class="card" style="display:none;">
    <div class="section-title">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
    <h3>Ø§Ø®ØªØ§Ø± Ø£Ù‚Ø±Ø¨ Ù…Ø­Ù„ ÙˆÙ…Ø´Ø±ÙˆØ¨Ùƒ</h3>
    <div id="locationMsg" class="small">
      <span class="pulse-dot"></span>
      Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø¹Ø±Ø¶ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª...
    </div>

    <!-- Ø£Ù‚Ø±Ø¨ Ù…Ø­Ù„ -->
    <div style="margin-top:.6rem;">
      <div class="store-chip">
        <span>Ø£Ù‚Ø±Ø¨ Ù…Ø­Ù„:</span>
        <span id="nearestStoreName">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
        <span class="distance" id="nearestStoreDistance"></span>
      </div>
      <button id="btnChangeStore" style="margin-top:.45rem;">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©</button>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ·ÙŠØ© -->
    <div class="store-list" id="storesStrip"></div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª -->
    <h4 style="margin-top:.8rem;">Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„</h4>
    <div id="drinksContainer">
      <div class="small">Ø§Ø®ØªØ± Ù…Ø­Ù„ Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª.</div>
    </div>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ -->
    <div style="margin-top:.8rem;border-top:1px dashed var(--border-subtle);padding-top:.5rem;">
      <div class="badge-soft">
        <span class="sparkle">âœ¦</span>
        <span>Ù…Ù„Ø®Øµ Ù„Ø­Ø¸ÙŠ Ù„Ù„Ø·Ù„Ø¨</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø±:</span>
        <span id="summaryStore">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨:</span>
        <span id="summaryDrink">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„:</span>
        <span class="big-price" id="summaryPrice">0 Ø¬</span>
      </div>
      <button id="btnPlaceOrder" class="primary" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
      <div id="orderMsg" class="success"></div>
    </div>
  </section>

  <!-- Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨ -->
  <section id="statusCard" class="card" style="display:none;">
    <div class="section-title">Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</div>
    <h3>Ø¢Ø®Ø± Ø·Ù„Ø¨</h3>
    <div id="lastOrderInfo" class="small"></div>
    <div class="timeline">
      <div class="timeline-step">
        <span class="status-dot" id="dotPending"></span>
        <span class="label">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotPreparing"></span>
        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotReady"></span>
        <span class="label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotDelivered"></span>
        <span class="label">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
      </div>
    </div>
    <button id="btnOpenDirections" style="margin-top:.7rem;display:none;">
      Ø§ÙØªØ­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ù„Ù„Ù…Ø­Ù„
    </button>
    <p class="hint">Ø®Ù„ÙŠÙƒ ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø©ØŒ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ø¨ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©.</p>
  </section>

</main>

<script>
  // 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyDatQR-gj_0D49LjQzcFQyn9zAmLd86NJs",
    authDomain: "hotspot-5525c.firebaseapp.com",
    projectId: "hotspot-5525c",
    storageBucket: "hotspot-5525c.firebasestorage.app",
    messagingSenderId: "499759771170",
    appId: "1:499759771170:web:aee6cf7965f7cc374ca47b",
    measurementId: "G-QBH7S7VEJK"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const authCard = document.getElementById('authCard');
  const profileCard = document.getElementById('profileCard');
  const orderCard = document.getElementById('orderCard');
  const statusCard = document.getElementById('statusCard');

  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const btnAuth = document.getElementById('btnAuth');
  const authMsg = document.getElementById('authMsg');

  const custName = document.getElementById('custName');
  const custPhone = document.getElementById('custPhone');
  const custCar = document.getElementById('custCar');
  const btnSaveProfile = document.getElementById('btnSaveProfile');
  const profileMsg = document.getElementById('profileMsg');

  const locationMsg = document.getElementById('locationMsg');
  const nearestStoreName = document.getElementById('nearestStoreName');
  const nearestStoreDistance = document.getElementById('nearestStoreDistance');
  const btnChangeStore = document.getElementById('btnChangeStore');
  const storesStrip = document.getElementById('storesStrip');
  const drinksContainer = document.getElementById('drinksContainer');

  const summaryStore = document.getElementById('summaryStore');
  const summaryDrink = document.getElementById('summaryDrink');
  const summaryPrice = document.getElementById('summaryPrice');
  const btnPlaceOrder = document.getElementById('btnPlaceOrder');
  const orderMsg = document.getElementById('orderMsg');

  const lastOrderInfo = document.getElementById('lastOrderInfo');
  const dotPending = document.getElementById('dotPending');
  const dotPreparing = document.getElementById('dotPreparing');
  const dotReady = document.getElementById('dotReady');
  const dotDelivered = document.getElementById('dotDelivered');
  const btnOpenDirections = document.getElementById('btnOpenDirections');

  let currentUser = null;
  let userDoc = null;
  let customerLocation = null;
  let stores = [];
  let selectedStore = null;
  let selectedDrink = null;
  let lastOrder = null;

  // 3) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
  btnAuth.onclick = async () => {
    authMsg.textContent = '';
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();
    if(!email || !pass){
      authMsg.textContent = 'Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
      return;
    }
    try{
      const cred = await auth.signInWithEmailAndPassword(email,pass);
      currentUser = cred.user;
      afterLogin();
    }catch(e){
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pass);
        currentUser = cred.user;
        await db.collection('users').doc(currentUser.uid).set({
          role: 'customer',
          email,
          name:'',
          phone:'',
          carNumber:'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        afterLogin();
      }catch(err){
        authMsg.textContent = err.message;
      }
    }
  };

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      currentUser = user;
      afterLogin();
    }
  });

  async function afterLogin(){
    authCard.style.display = 'none';
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if(doc.exists){
      userDoc = doc.data();
      custName.value = userDoc.name || '';
      custPhone.value = userDoc.phone || '';
      custCar.value = userDoc.carNumber || '';
    }
    profileCard.style.display = 'block';
    orderCard.style.display = 'block';
    statusCard.style.display = 'block';
    getLocationAndLoadStores();
    listenLastOrder();
  }

  // 4) Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
  btnSaveProfile.onclick = async () => {
    profileMsg.textContent = '';
    const name = custName.value.trim();
    const phone = custPhone.value.trim();
    const car = custCar.value.trim();
    if(!name || !phone){
      profileMsg.style.color = '#e8504f';
      profileMsg.textContent = 'Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.';
      return;
    }
    try{
      await db.collection('users').doc(currentUser.uid).update({
        name, phone, carNumber:car
      });
      profileMsg.style.color = '#2e7d32';
      profileMsg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
    }catch(e){
      profileMsg.style.color = '#e8504f';
      profileMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
    }
  };

  // 5) Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ + ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª
  function getLocationAndLoadStores(){
    if(!navigator.geolocation){
      locationMsg.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª.';
      loadStores();
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      customerLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      locationMsg.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª...';
      loadStores();
    },err=>{
      locationMsg.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª.';
      loadStores();
    });
  }

  async function loadStores(){
    const snap = await db.collection('stores').where('isActive','==',true).get();
    stores = [];
    snap.forEach(d=>{
      const s = d.data();
      s.id = d.id;
      stores.push(s);
    });
    if(stores.length === 0){
      locationMsg.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
      return;
    }
    if(customerLocation){
      for(const s of stores){
        if(s.location && s.location.latitude){
          s.distanceKm = haversine(
            customerLocation.lat,customerLocation.lng,
            s.location.latitude,s.location.longitude
          );
        }else{
          s.distanceKm = 9999;
        }
      }
      stores.sort((a,b)=>a.distanceKm - b.distanceKm);
    }
    renderStoresStrip();
    selectStore(stores[0]);
  }

  function haversine(lat1,lon1,lat2,lon2){
    const R = 6371;
    const toRad = d=>d*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

  function renderStoresStrip(){
    storesStrip.innerHTML = '';
    stores.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'store-card';
      card.onclick = ()=>selectStore(s);
      card.dataset.id = s.id;
      card.innerHTML = `
        <div class="store-name">${s.name || 'Ù…Ø­Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
        <div class="store-meta">
          ${s.address || ''}<br>
          ${s.distanceKm && s.distanceKm < 9000 ? (s.distanceKm.toFixed(1)+' ÙƒÙ… ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹') : ''}
        </div>
      `;
      storesStrip.appendChild(card);
    });
  }

  function selectStore(store){
    selectedStore = store;
    selectedDrink = null;
    [...storesStrip.children].forEach(c=>{
      c.classList.toggle('active', c.dataset.id === store.id);
    });
    nearestStoreName.textContent = store.name;
    if(store.distanceKm && store.distanceKm < 9000){
      const mins = Math.round((store.distanceKm/30)*60);
      nearestStoreDistance.textContent = `â‰ˆ ${store.distanceKm.toFixed(1)} ÙƒÙ… / ${mins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    }else{
      nearestStoreDistance.textContent = '';
    }
    summaryStore.textContent = store.name;
    summaryDrink.textContent = 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    summaryPrice.textContent = '0 Ø¬';
    btnPlaceOrder.disabled = true;
    loadDrinksForStore(store.id);
  }

  btnChangeStore.onclick = ()=>{
    storesStrip.scrollTo({left:0,behavior:'smooth'});
  };

  // 6) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª
  async function loadDrinksForStore(storeId){
    drinksContainer.innerHTML = '<div class="small">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª...</div>';
    const snap = await db.collection('drinks').where('storeId','==',storeId).get();
    if(snap.empty){
      drinksContainer.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
      return;
    }
    const list = document.createElement('div');
    list.className = 'drink-list';
    snap.forEach(d=>{
      const drink = d.data();
      const base = drink.basePrice || drink.price || 0;
      const finalPrice = base + 5; // Ø§Ù„Ø®Ø¯Ù…Ø© ØªØ¶Ø§Ù ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© ÙÙ‚Ø·
      const card = document.createElement('div');
      card.className = 'drink-card';
      card.onclick = ()=>{
        selectDrink({id:d.id,name:drink.name,basePrice:base,finalPrice});
      };
      card.innerHTML = `
        <div class="drink-name">${drink.name}</div>
        <div class="drink-price">${finalPrice} Ø¬</div>
        <div class="pill">Ø¬Ø§Ù‡Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø·Ø±ÙŠÙ‚</div>
      `;
      list.appendChild(card);
    });
    drinksContainer.innerHTML = '';
    drinksContainer.appendChild(list);
  }

  function selectDrink(drink){
    selectedDrink = drink;
    const cards = drinksContainer.querySelectorAll('.drink-card');
    cards.forEach(c=>{
      const name = c.querySelector('.drink-name').textContent.trim();
      c.classList.toggle('active', name === drink.name);
    });
    summaryDrink.textContent = drink.name;
    summaryPrice.textContent = drink.finalPrice + ' Ø¬';
    btnPlaceOrder.disabled = false;
  }

  // 7) Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨
  btnPlaceOrder.onclick = async ()=>{
    orderMsg.textContent = '';
    if(!selectedStore || !selectedDrink){
      orderMsg.style.color='#e8504f';
      orderMsg.textContent='Ø§Ø®ØªØ± Ù…Ø­Ù„ ÙˆÙ…Ø´Ø±ÙˆØ¨ Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }
    const car = custCar.value.trim();
    const name = custName.value.trim();
    if(!name){
      orderMsg.style.color='#e8504f';
      orderMsg.textContent='Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }
    let customerGeo = null;
    if(customerLocation){
      customerGeo = new firebase.firestore.GeoPoint(customerLocation.lat,customerLocation.lng);
    }
    const baseTotal = selectedDrink.basePrice;
    const serviceTotal = 5;
    const driverTotal = 0;
    const totalCustomerPrice = baseTotal + serviceTotal + driverTotal;
    const orderData = {
      customerId: currentUser.uid,
      storeId: selectedStore.id,
      driverId: null,
      items:[{
        drinkId: selectedDrink.id,
        drinkName: selectedDrink.name,
        basePrice: selectedDrink.basePrice,
        serviceFee: 5,
        driverFee: 0,
        totalItemPrice: totalCustomerPrice
      }],
      baseTotal,
      serviceTotal,
      driverTotal,
      totalCustomerPrice,
      carNumber: car,
      customerLocation: customerGeo,
      status: 'pending',
      platformCommissionSettled: false,
      driverPaid: false,
      storePaidOut: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try{
      await db.collection('orders').add(orderData);
      orderMsg.style.color='#2e7d32';
      orderMsg.textContent='ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„.';
      btnPlaceOrder.disabled = true;
    }catch(e){
      orderMsg.style.color='#e8504f';
      orderMsg.textContent='Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.';
    }
  };

  // 8) Ù…ØªØ§Ø¨Ø¹Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„
  function listenLastOrder(){
    db.collection('orders')
      .where('customerId','==',auth.currentUser.uid)
      .orderBy('createdAt','desc').limit(1)
      .onSnapshot(snap=>{
        lastOrder = null;
        snap.forEach(doc=>{
          lastOrder = doc.data();
        });
        renderLastOrder();
      });
  }

  function renderLastOrder(){
    if(!lastOrder){
      statusCard.style.display='none';
      return;
    }
    statusCard.style.display='block';
    const drinkName = lastOrder.drinkName || (lastOrder.items && lastOrder.items[0]?.drinkName) || '';
    const price = lastOrder.totalCustomerPrice || lastOrder.items?.[0]?.totalItemPrice || '';
    lastOrderInfo.textContent = `${drinkName} â€¢ ${price} Ø¬ â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${lastOrder.status}`;
    const st = lastOrder.status;
    dotPending.classList.toggle('active', ['pending','accepted','preparing','ready','on_the_way','delivered'].includes(st));
    dotPreparing.classList.toggle('active', ['preparing','ready','on_the_way','delivered'].includes(st));
    dotReady.classList.toggle('active', ['ready','on_the_way','delivered'].includes(st));
    dotDelivered.classList.toggle('active', ['delivered'].includes(st));

    if(st === 'ready' || st === 'on_the_way'){
      btnOpenDirections.style.display='block';
      btnOpenDirections.onclick = ()=>{
        if(!selectedStore || !selectedStore.location){
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø­Ù„.');
          return;
        }
        const lat = selectedStore.location.latitude;
        const lng = selectedStore.location.longitude;
        const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
        window.open(url,'_blank');
      };
    }else{
      btnOpenDirections.style.display='none';
    }
  }
</script>
</body>
</html>
