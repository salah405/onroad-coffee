<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ù…ØªØ¹Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚ - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      /* Semiâ€‘dark gray coffee theme */
      --bg: #111827;
      --bg-elevated: #1f2933;
      --bg-elevated-2: #273549;
      --border-subtle: #374151;
      --text-main: #f9fafb;
      --text-sub: #9ca3af;
      --accent: #f59e0b;
      --accent-soft: rgba(245,158,11,0.16);
      --danger: #f97373;
      --success: #4ade80;
      --shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Cairo",system-ui,Arial;
      background:
        radial-gradient(circle at 0% 0%,#1f2937 0,#111827 55%,#020617 100%);
      color:var(--text-main);
      -webkit-font-smoothing:antialiased;
    }

    header{
      padding:.9rem 1rem;
      background:
        radial-gradient(circle at top,#1f2937 0,#020617 70%);
      color:var(--text-main);
      text-align:center;
      position:sticky;
      top:0;
      z-index:10;
      backdrop-filter:blur(18px);
      border-bottom:1px solid rgba(148,163,184,0.25);
      box-shadow:0 18px 40px rgba(0,0,0,0.65);
    }
    header .logo{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:.75rem;
    }
    header .logo-icon{
      width:46px;
      height:46px;
      border-radius:18px;
      background:
        #020617
        url("img/logo-coffee.png") center center/cover no-repeat;
      box-shadow:
        0 0 0 1px rgba(248,250,252,0.35),
        0 12px 30px rgba(0,0,0,0.9);
    }
    header .logo-text-main{
      font-weight:800;
      letter-spacing:.04em;
      font-size:1.08rem;
    }
    header .logo-text-sub{
      font-size:.8rem;
      color:var(--text-sub);
    }

    main{
      max-width:500px;
      margin:0 auto;
      padding:1rem .9rem 1.1rem;
    }

    .card{
      background:radial-gradient(circle at top,#111827,#020617);
      border-radius:20px;
      padding:1rem 1.1rem;
      box-shadow:var(--shadow-soft);
      margin-bottom:1rem;
      border:1px solid var(--border-subtle);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:
        radial-gradient(circle at 0% 0%,rgba(245,158,11,0.16),transparent 55%),
        radial-gradient(circle at 100% 0%,rgba(59,130,246,0.15),transparent 60%);
      opacity:.95;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .card > *{position:relative;}

    h2,h3,h4{margin:.2rem 0 .5rem;}
    h2{font-size:1.2rem;}
    h3{font-size:1.05rem;}
    h4{font-size:.98rem;}
    label{display:block;margin-top:.4rem;font-size:.9rem;color:var(--text-sub);}

    input,button,select,textarea{
      width:100%;
      padding:.75rem .85rem;
      margin-top:.3rem;
      border-radius:999px;
      border:1px solid var(--border-subtle);
      font-family:inherit;
      font-size:.9rem;
      outline:none;
      background:#020617;
      color:var(--text-main);
      transition:border-color .18s,box-shadow .18s,background .18s,transform .08s;
    }
    textarea{
      border-radius:14px;
      min-height:72px;
      resize:vertical;
    }
    input:focus,select:focus,textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(245,158,11,0.6);
      background:#020617;
    }

    button{
      background:linear-gradient(140deg,#f59e0b,#f97316);
      color:#020617;
      border:none;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.03em;
      position:relative;
      overflow:hidden;
    }
    button::after{
      content:"";
      position:absolute;
      top:0;left:-40%;
      width:40%;
      height:100%;
      background:linear-gradient(115deg,rgba(255,255,255,0.7),transparent 65%);
      transform:skewX(-20deg) translateX(-120%);
      transition:transform .4s;
      pointer-events:none;
    }
    button:hover::after{
      transform:skewX(-20deg) translateX(260%);
    }
    button:active{
      transform:scale(.97);
      box-shadow:none;
    }
    button:disabled{
      opacity:.55;
      cursor:default;
      background:linear-gradient(140deg,#4b5563,#374151);
      color:var(--text-sub);
    }
    button.primary{
      box-shadow:0 12px 26px rgba(245,158,11,0.5);
    }
    .btn-ghost{
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(148,163,184,0.4);
    }

    .error{color:var(--danger);font-size:.8rem;margin-top:.25rem;}
    .success{color:var(--success);font-size:.8rem;margin-top:.25rem;}

    .small{
      font-size:.8rem;color:var(--text-sub);
    }

    .store-chip{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:.4rem;
      padding:.45rem .85rem;
      background:rgba(15,23,42,0.9);
      border-radius:14px;
      font-size:.8rem;
      border:1px solid var(--border-subtle);
      box-shadow:0 8px 20px rgba(0,0,0,0.65);
    }
    .store-chip span.distance{
      color:var(--accent);font-weight:700;
    }
    .pulse-dot{
      width:9px;height:9px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 0 rgba(245,158,11,0.65);
      animation:pulse 1.7s infinite;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(245,158,11,0.65);}
      70%{box-shadow:0 0 0 10px rgba(245,158,11,0);}
      100%{box-shadow:0 0 0 0 rgba(245,158,11,0);}
    }

    .section-title{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--text-sub);
      margin-bottom:.25rem;
    }

    /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª */
    .stores-list-vertical{
      margin-top:.7rem;
      display:flex;
      flex-direction:column;
      gap:.55rem;
    }
    .store-card{
      background:linear-gradient(135deg,#020617,#111827);
      border-radius:16px;
      padding:.6rem .75rem .65rem;
      border:1px solid rgba(75,85,99,0.9);
      position:relative;
      overflow:hidden;
      transition:border-color .18s,box-shadow .18s,transform .12s,background .18s;
    }
    .store-card.active{
      border-color:var(--accent);
      box-shadow:0 16px 40px rgba(0,0,0,0.95);
      transform:translateY(-1px);
      background:radial-gradient(circle at top,#1f2937,#020617);
    }
    .store-name{
      font-weight:700;
      margin-bottom:.15rem;
    }
    .store-meta{
      font-size:.78rem;
      color:var(--text-sub);
      line-height:1.4;
    }
    .store-actions{
      margin-top:.4rem;
      display:flex;
      gap:.35rem;
    }
    .btn-xs{
      padding:.35rem .6rem;
      font-size:.75rem;
      border-radius:999px;
      width:auto;
    }

    /* Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª */
    .drink-list{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.65rem;
      margin-top:.55rem;
    }
    .drink-card{
      background:linear-gradient(145deg,#020617,#111827);
      border-radius:16px;
      padding:.55rem .55rem .6rem;
      text-align:center;
      cursor:pointer;
      border:1px solid rgba(55,65,81,0.9);
      position:relative;
      overflow:hidden;
      transition:border-color .18s,box-shadow .18s,transform .1s,background .18s;
    }
    .drink-card.active{
      border-color:var(--accent);
      box-shadow:0 12px 30px rgba(0,0,0,0.95);
      transform:translateY(-1px);
      background:radial-gradient(circle at top,#1f2937,#020617);
    }
    .drink-name{font-weight:700;font-size:.9rem;}
    .drink-price{font-size:.85rem;color:var(--accent);margin-top:.25rem;}
    .pill{
      display:inline-block;
      padding:.18rem .6rem;
      border-radius:999px;
      font-size:.7rem;
      background:var(--accent-soft);
      color:var(--accent);
      margin-top:.25rem;
      font-weight:600;
    }

    /* Ø§Ù„Ø³Ù„Ø© / Ø§Ù„Ù…Ù„Ø®Øµ */
    .summary-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:.45rem;
      font-size:.9rem;
    }
    .big-price{
      font-size:1.25rem;
      font-weight:800;
      color:var(--accent);
    }
    .badge-soft{
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      padding:.18rem .6rem;
      border-radius:999px;
      font-size:.72rem;
      background:rgba(15,23,42,0.9);
      color:var(--accent);
      font-weight:600;
      border:1px solid rgba(55,65,81,0.9);
    }
    .cart-items{
      margin-top:.4rem;
      font-size:.8rem;
      color:var(--text-sub);
      max-height:120px;
      overflow-y:auto;
    }

    /* Ø§Ù„ØªØ§ÙŠÙ…Ù„Ø§ÙŠÙ† */
    .status-dot{
      width:11px;height:11px;border-radius:50%;
      background:#4b5563;
      display:inline-block;margin-left:.3rem;
      box-shadow:0 0 0 0 rgba(74,222,128,0);
      transition:background .18s,box-shadow .25s;
    }
    .status-dot.active{
      background:var(--success);
      box-shadow:0 0 0 4px rgba(74,222,128,0.25);
    }
    .timeline{
      display:flex;
      justify-content:space-between;
      margin-top:.65rem;
      font-size:.75rem;
      color:var(--text-sub);
    }
    .timeline-step{text-align:center;flex:1;}
    .timeline-step span.label{display:block;margin-top:.22rem;}

    .hint{
      font-size:.78rem;
      color:var(--text-sub);
      margin-top:.15rem;
    }

    /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙƒØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¨ */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.85);
      display:none;
      align-items:flex-end;
      justify-content:center;
      z-index:20;
    }
    .modal{
      width:100%;
      max-width:500px;
      background:#020617;
      border-radius:20px 20px 0 0;
      padding:1rem 1rem 1.1rem;
      border-top:1px solid #374151;
      box-shadow:0 -10px 30px rgba(0,0,0,0.7);
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:.4rem;
    }
    .modal-close{
      background:transparent;
      border:none;
      color:var(--text-sub);
      font-size:1.1rem;
      width:auto;
      padding:0 .4rem;
    }
  </style>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div>
      <div class="logo-text-main">Ø§Ù„Ù…ØªØ¹Ø© ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</div>
      <div class="logo-text-sub">Ù‚Ù‡ÙˆØªÙƒ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ùƒ ÙˆØ£Ù†Øª Ø³Ø§ÙŠÙ‚</div>
    </div>
  </div>
</header>

<main>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
  <section id="authCard" class="card">
    <div class="section-title">Ø­Ø³Ø§Ø¨Ùƒ</div>
    <h2>Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ğŸ‘‹</h2>
    <p class="small">Ø³Ø¬Ù‘Ù„ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø·Ù„Ø¨Ùƒ ÙŠØªÙ… ÙÙŠ Ø«ÙˆØ§Ù†ÙŠ.</p>
    <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input type="email" id="email" placeholder="example@mail.com" />
    <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" />
    <button id="btnAuth" class="primary">Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <div id="authMsg" class="error"></div>
  </section>

  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <section id="profileCard" class="card" style="display:none;">
    <div class="section-title">Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</div>
    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø³ÙŠØ§Ø±ØªÙƒ</h3>
    <p class="small">ØªÙØ­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ØªØ­ØªØ§Ø¬ ØªØ¯Ø®Ù„Ù‡Ø§ ØªØ§Ù†ÙŠ.</p>
    <label>Ø§Ù„Ø§Ø³Ù…</label>
    <input type="text" id="custName" placeholder="Ø§Ù„Ø§Ø³Ù… ÙƒØ§Ù…Ù„" />
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
    <input type="tel" id="custPhone" placeholder="01xxxxxxxxx" />
    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
    <input type="text" id="custCar" placeholder="Ù…Ø«Ø§Ù„: Ø³ Ø¹ 1234" />
    <button id="btnSaveProfile">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <div id="profileMsg" class="success"></div>
  </section>

  <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <section id="orderCard" class="card" style="display:none;">
    <div class="section-title">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</div>
    <h3>Ø§Ø®ØªØ§Ø± Ø§Ù„Ù…Ø­Ù„ Ø¹Ù„Ù‰ Ø·Ø±ÙŠÙ‚Ùƒ</h3>
    <div id="locationMsg" class="small">
      <span class="pulse-dot"></span>
      Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù‚Ø±ÙŠØ¨Ø©...
    </div>

    <!-- Ø£Ù‚Ø±Ø¨ Ù…Ø­Ù„ -->
    <div style="margin-top:.6rem;">
      <div class="store-chip">
        <div>
          <div class="small">Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­ Ø§Ù„Ø¢Ù†</div>
          <div id="nearestStoreName">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</div>
        </div>
        <div class="distance" id="nearestStoreDistance"></div>
      </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ù„Ø§Øª Ø§Ù„Ù…Ù†Ø¸Ù…Ø© -->
    <h4 style="margin-top:.8rem;">Ù…Ø­Ù„Ø§Øª Ù‚Ø±ÙŠØ¨Ø©</h4>
    <div id="storesStrip" class="stores-list-vertical"></div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª -->
    <h4 style="margin-top:.8rem;">Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„</h4>
    <div id="drinksContainer">
      <div class="small">Ø§Ø®ØªØ± Ù…Ø­Ù„ Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª.</div>
    </div>

    <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ù„Ø¨ -->
    <label style="margin-top:.7rem;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <textarea id="orderNote" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¯ÙˆÙ† Ø³ÙƒØ±ØŒ ÙÙˆÙ… Ø²ÙŠØ§Ø¯Ø©ØŒ Ø£Ø­ØªØ§Ø¬ ØºØ·Ø§Ø¡ Ù…Ø­ÙƒÙ…."></textarea>

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨ -->
    <div style="margin-top:.8rem;border-top:1px dashed var(--border-subtle);padding-top:.5rem;">
      <div class="badge-soft">
        <span>âœ¦</span>
        <span>Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø§Ù„Ù…Ø­Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø±:</span>
        <span id="summaryStore">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª:</span>
        <span id="summaryItemsCount">0</span>
      </div>
      <div class="summary-row">
        <span class="small">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„:</span>
        <span class="big-price" id="summaryPrice">0 Ø¬</span>
      </div>
      <div class="cart-items" id="cartItemsPreview"></div>
      <button id="btnPlaceOrder" class="primary" disabled>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†</button>
      <div id="orderMsg" class="success"></div>
    </div>
  </section>

  <!-- Ø­Ø§Ù„Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨ -->
  <section id="statusCard" class="card" style="display:none;">
    <div class="section-title">Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ</div>
    <h3>Ø¢Ø®Ø± Ø·Ù„Ø¨</h3>
    <div id="lastOrderInfo" class="small"></div>
    <div class="timeline">
      <div class="timeline-step">
        <span class="status-dot" id="dotPending"></span>
        <span class="label">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotPreparing"></span>
        <span class="label">Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotReady"></span>
        <span class="label">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
      </div>
      <div class="timeline-step">
        <span class="status-dot" id="dotDelivered"></span>
        <span class="label">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</span>
      </div>
    </div>
    <button id="btnOpenDirections" style="margin-top:.7rem;display:none;">
      Ø§ÙØªØ­ Ø§Ù„Ø§ØªØ¬Ø§Ù‡Ø§Øª Ù„Ù„Ù…Ø­Ù„
    </button>
    <p class="hint">Ø®Ù„ÙŠÙƒ ÙØ§ØªØ­ Ø§Ù„ØµÙØ­Ø©ØŒ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ùƒ Ø¨ØªØªØ­Ø¯Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©.</p>
  </section>

</main>

<!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙƒØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¨ -->
<div id="drinkModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h4 id="modalDrinkName">Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¨</h4>
      <button class="modal-close" id="modalCloseBtn">âœ•</button>
    </div>
    <label>Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³ÙƒØ±</label>
    <select id="modalSugarSelect">
      <option value="normal">Ù…Ø¸Ø¨ÙˆØ·</option>
      <option value="no">Ø³Ø§Ø¯Ø©</option>
      <option value="extra">Ø²ÙŠØ§Ø¯Ø©</option>
    </select>
    <label style="margin-top:.6rem;">Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <textarea id="modalItemNote" placeholder="Ù…Ø«Ø§Ù„: Ø¨Ø¯ÙˆÙ† ÙÙˆÙ…ØŒ Ø­Ù„ÙŠØ¨ Ù„ÙˆØ²ØŒ ÙƒÙˆØ¨ ÙƒØ¨ÙŠØ±."></textarea>
    <button id="modalAddBtn" class="primary" style="margin-top:.7rem;">
      Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©
    </button>
  </div>
</div>

<script>
  // 1) Ø¥Ø¹Ø¯Ø§Ø¯ Firebase Ø¨Ù†ÙØ³ Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyDatQR-gj_0D49LjQzcFQyn9zAmLd86NJs",
    authDomain: "hotspot-5525c.firebaseapp.com",
    projectId: "hotspot-5525c",
    storageBucket: "hotspot-5525c.firebasestorage.app",
    messagingSenderId: "499759771170",
    appId: "1:499759771170:web:aee6cf7965f7cc374ca47b",
    measurementId: "G-QBH7S7VEJK"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db   = firebase.firestore();

  // 2) Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const authCard = document.getElementById('authCard');
  const profileCard = document.getElementById('profileCard');
  const orderCard = document.getElementById('orderCard');
  const statusCard = document.getElementById('statusCard');

  const emailInput = document.getElementById('email');
  const passInput = document.getElementById('password');
  const btnAuth = document.getElementById('btnAuth');
  const authMsg = document.getElementById('authMsg');

  const custName = document.getElementById('custName');
  const custPhone = document.getElementById('custPhone');
  const custCar = document.getElementById('custCar');
  const btnSaveProfile = document.getElementById('btnSaveProfile');
  const profileMsg = document.getElementById('profileMsg');

  const locationMsg = document.getElementById('locationMsg');
  const nearestStoreName = document.getElementById('nearestStoreName');
  const nearestStoreDistance = document.getElementById('nearestStoreDistance');
  const storesStrip = document.getElementById('storesStrip');
  const drinksContainer = document.getElementById('drinksContainer');

  const orderNote = document.getElementById('orderNote');

  const summaryStore = document.getElementById('summaryStore');
  const summaryItemsCount = document.getElementById('summaryItemsCount');
  const summaryPrice = document.getElementById('summaryPrice');
  const cartItemsPreview = document.getElementById('cartItemsPreview');
  const btnPlaceOrder = document.getElementById('btnPlaceOrder');
  const orderMsg = document.getElementById('orderMsg');

  const lastOrderInfo = document.getElementById('lastOrderInfo');
  const dotPending = document.getElementById('dotPending');
  const dotPreparing = document.getElementById('dotPreparing');
  const dotReady = document.getElementById('dotReady');
  const dotDelivered = document.getElementById('dotDelivered');
  const btnOpenDirections = document.getElementById('btnOpenDirections');

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
  const drinkModalBackdrop = document.getElementById('drinkModalBackdrop');
  const modalDrinkName = document.getElementById('modalDrinkName');
  const modalSugarSelect = document.getElementById('modalSugarSelect');
  const modalItemNote = document.getElementById('modalItemNote');
  const modalAddBtn = document.getElementById('modalAddBtn');
  const modalCloseBtn = document.getElementById('modalCloseBtn');

  let currentUser = null;
  let userDoc = null;
  let customerLocation = null;
  let stores = [];
  let selectedStore = null;
  let lastOrder = null;

  // Ø³Ù„Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª
  let cartItems = []; // [{id,name,basePrice,quantity,sugarLevel,itemNote}]
  let modalCurrentDrink = null;

  // 3) ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨
  btnAuth.onclick = async () => {
    authMsg.textContent = '';
    const email = emailInput.value.trim();
    const pass = passInput.value.trim();
    if(!email || !pass){
      authMsg.textContent = 'Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.';
      return;
    }
    try{
      const cred = await auth.signInWithEmailAndPassword(email,pass);
      currentUser = cred.user;
      afterLogin();
    }catch(e){
      try{
        const cred = await auth.createUserWithEmailAndPassword(email,pass);
        currentUser = cred.user;
        await db.collection('users').doc(currentUser.uid).set({
          role: 'customer',
          email,
          name:'',
          phone:'',
          carNumber:'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        afterLogin();
      }catch(err){
        authMsg.textContent = err.message;
      }
    }
  };

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      currentUser = user;
      afterLogin();
    }
  });

  async function afterLogin(){
    authCard.style.display = 'none';
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if(doc.exists){
      userDoc = doc.data();
      custName.value = userDoc.name || '';
      custPhone.value = userDoc.phone || '';
      custCar.value = userDoc.carNumber || '';
    }
    profileCard.style.display = 'block';
    orderCard.style.display = 'block';
    statusCard.style.display = 'block';
    getLocationAndLoadStores();
    listenLastOrder();
  }

  // 4) Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
  btnSaveProfile.onclick = async () => {
    profileMsg.textContent = '';
    const name = custName.value.trim();
    const phone = custPhone.value.trim();
    const car = custCar.value.trim();
    if(!name || !phone){
      profileMsg.style.color = '#f97373';
      profileMsg.textContent = 'Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ø·Ù„ÙˆØ¨Ø§Ù†.';
      return;
    }
    try{
      await db.collection('users').doc(currentUser.uid).update({
        name, phone, carNumber:car
      });
      profileMsg.style.color = '#4ade80';
      profileMsg.textContent = 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
    }catch(e){
      profileMsg.style.color = '#f97373';
      profileMsg.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.';
    }
  };

  // 5) Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ + ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª
  function getLocationAndLoadStores(){
    if(!navigator.geolocation){
      locationMsg.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª.';
      loadStores();
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      customerLocation = {
        lat: pos.coords.latitude,
        lng: pos.coords.longitude
      };
      locationMsg.textContent = 'ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø£Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø­Ù„Ø§Øª...';
      loadStores();
    },err=>{
      locationMsg.textContent = 'ØªØ¹Ø°Ø± Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ÙƒØŒ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ù„Ø§Øª.';
      loadStores();
    });
  }

  async function loadStores(){
    const snap = await db.collection('stores').where('isActive','==',true).get();
    stores = [];
    snap.forEach(d=>{
      const s = d.data();
      s.id = d.id;
      stores.push(s);
    });
    if(stores.length === 0){
      locationMsg.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ù„Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.';
      return;
    }
    if(customerLocation){
      for(const s of stores){
        if(s.location && s.location.latitude){
          s.distanceKm = haversine(
            customerLocation.lat,customerLocation.lng,
            s.location.latitude,s.location.longitude
          );
        }else{
          s.distanceKm = 9999;
        }
      }
      stores.sort((a,b)=>a.distanceKm - b.distanceKm);
    }
    renderStoresList();
    selectStore(stores[0]);
  }

  function haversine(lat1,lon1,lat2,lon2){
    const R = 6371;
    const toRad = d=>d*Math.PI/180;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
      Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    return R*c;
  }

  function renderStoresList(){
    storesStrip.innerHTML = '';
    stores.forEach(s=>{
      const card = document.createElement('div');
      card.className = 'store-card';
      card.dataset.id = s.id;
      const distanceText = (s.distanceKm && s.distanceKm < 9000)
        ? `${s.distanceKm.toFixed(1)} ÙƒÙ… ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹`
        : '';
      card.innerHTML = `
        <div class="store-name">${s.name || 'Ù…Ø­Ù„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
        <div class="store-meta">
          ${(s.address || '')}
          ${distanceText ? '<br>' + distanceText : ''}
        </div>
        <div class="store-actions">
          <button class="btn-xs primarySelect">Ø§Ø®ØªÙŠØ§Ø± Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ù„</button>
          <button class="btn-xs btn-ghost mapBtn">Ø´ÙˆÙ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        </div>
      `;
      card.querySelector('.primarySelect').onclick = (e)=>{
        e.stopPropagation();
        selectStore(s);
      };
      card.querySelector('.mapBtn').onclick = (e)=>{
        e.stopPropagation();
        openDirectionsToStore(s);
      };
      card.onclick = ()=>selectStore(s);
      storesStrip.appendChild(card);
    });
  }

  function selectStore(store){
    selectedStore = store;
    cartItems = []; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ù„Ø© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ù„
    updateCartUI();

    [...storesStrip.children].forEach(c=>{
      c.classList.toggle('active', c.dataset.id === store.id);
    });

    nearestStoreName.textContent = store.name;
    if(store.distanceKm && store.distanceKm < 9000){
      const mins = Math.round((store.distanceKm/30)*60);
      nearestStoreDistance.textContent = `â‰ˆ ${store.distanceKm.toFixed(1)} ÙƒÙ… / ${mins} Ø¯Ù‚ÙŠÙ‚Ø©`;
    }else{
      nearestStoreDistance.textContent = '';
    }
    summaryStore.textContent = store.name;
    btnPlaceOrder.disabled = true;
    loadDrinksForStore(store.id);
  }

  function openDirectionsToStore(store){
    if(!store || !store.location){
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø­Ù„.');
      return;
    }
    const lat = store.location.latitude;
    const lng = store.location.longitude;
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    window.open(url,'_blank');
  }

  // 6) ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª
  async function loadDrinksForStore(storeId){
    drinksContainer.innerHTML = '<div class="small">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª...</div>';
    const snap = await db.collection('drinks').where('storeId','==',storeId).get();
    if(snap.empty){
      drinksContainer.innerHTML = '<div class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
      return;
    }
    const list = document.createElement('div');
    list.className = 'drink-list';
    snap.forEach(d=>{
      const drink = d.data();
      const base = drink.basePrice || drink.price || 0;
      const finalPrice = base + 5;
      const card = document.createElement('div');
      card.className = 'drink-card';
      card.onclick = ()=>{
        openDrinkModal({id:d.id,name:drink.name,basePrice:base});
      };
      card.innerHTML = `
        <div class="drink-name">${drink.name}</div>
        <div class="drink-price">${finalPrice} Ø¬</div>
        <div class="pill">Ø§Ø®ØªÙŠØ§Ø±</div>
      `;
      list.appendChild(card);
    });
    drinksContainer.innerHTML = '';
    drinksContainer.appendChild(list);
  }

  // Ù…ÙˆØ¯Ø§Ù„: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙƒØ± + Ù…Ù„Ø§Ø­Ø¸Ø© Ù„Ù„Ù…Ø´Ø±ÙˆØ¨
  function openDrinkModal(drink){
    if(!selectedStore){
      orderMsg.style.color='#f97373';
      orderMsg.textContent='Ø§Ø®ØªØ± Ù…Ø­Ù„ Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }
    modalCurrentDrink = drink;
    modalDrinkName.textContent = drink.name;
    modalSugarSelect.value = 'normal';
    modalItemNote.value = '';
    drinkModalBackdrop.style.display = 'flex';
  }
  function closeDrinkModal(){
    drinkModalBackdrop.style.display = 'none';
    modalCurrentDrink = null;
  }
  modalCloseBtn.onclick = closeDrinkModal;
  drinkModalBackdrop.onclick = (e)=>{
    if(e.target === drinkModalBackdrop) closeDrinkModal();
  };
  modalAddBtn.onclick = ()=>{
    if(!modalCurrentDrink) return;
    const sugarLevel = modalSugarSelect.value || 'normal';
    const itemNote = modalItemNote.value.trim() || null;
    addDrinkToCart(modalCurrentDrink,sugarLevel,itemNote);
    closeDrinkModal();
  };

  function addDrinkToCart(drink,sugarLevel,itemNote){
    orderMsg.textContent = '';
    const existing = cartItems.find(i=>i.id === drink.id && i.sugarLevel === sugarLevel && i.itemNote === itemNote);
    if(existing){
      existing.quantity += 1;
    }else{
      cartItems.push({
        id: drink.id,
        name: drink.name,
        basePrice: drink.basePrice,
        quantity: 1,
        sugarLevel,
        itemNote
      });
    }
    updateCartUI();
  }

  function updateCartUI(){
    const totalItems = cartItems.reduce((s,i)=>s + i.quantity,0);
    summaryItemsCount.textContent = totalItems;
    const baseTotal = cartItems.reduce((s,i)=>s + i.basePrice * i.quantity,0);
    const serviceTotal = cartItems.reduce((s,i)=>s + 5 * i.quantity,0);
    const totalCustomerPrice = baseTotal + serviceTotal;
    summaryPrice.textContent = totalCustomerPrice + ' Ø¬';

    cartItemsPreview.innerHTML = '';
    if(cartItems.length === 0){
      cartItemsPreview.textContent = 'Ù„Ù… ØªØ¶Ù Ø£ÙŠ Ù…Ø´Ø±ÙˆØ¨ Ø¨Ø¹Ø¯.';
      btnPlaceOrder.disabled = true;
      return;
    }
    cartItems.forEach(i=>{
      const line = document.createElement('div');
      const sugarLabel = i.sugarLevel === 'no' ? 'Ø³Ø§Ø¯Ø©' :
        i.sugarLevel === 'extra' ? 'Ø²ÙŠØ§Ø¯Ø©' : 'Ù…Ø¸Ø¨ÙˆØ·';
      const notePart = i.itemNote ? ` â€¢ ${i.itemNote}` : '';
      line.textContent = `${i.name} Ã— ${i.quantity} â€¢ ${sugarLabel}${notePart}`;
      cartItemsPreview.appendChild(line);
    });
    btnPlaceOrder.disabled = false;
  }

  // 7) Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨
  btnPlaceOrder.onclick = async ()=>{
    orderMsg.textContent = '';
    if(!selectedStore || cartItems.length === 0){
      orderMsg.style.color='#f97373';
      orderMsg.textContent='Ø§Ø®ØªØ± Ù…Ø­Ù„ ÙˆØ£Ø¶Ù Ù…Ø´Ø±ÙˆØ¨ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.';
      return;
    }
    const car = custCar.value.trim();
    const name = custName.value.trim();
    if(!name){
      orderMsg.style.color='#f97373';
      orderMsg.textContent='Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.';
      return;
    }
    let customerGeo = null;
    if(customerLocation){
      customerGeo = new firebase.firestore.GeoPoint(customerLocation.lat,customerLocation.lng);
    }

    const items = cartItems.map(item=>{
      const base = item.basePrice;
      const serviceFee = 5;
      const driverFee = 0;
      const totalItemPrice = (base + serviceFee + driverFee) * item.quantity;
      return {
        drinkId: item.id,
        drinkName: item.name,
        basePrice: base,
        quantity: item.quantity,
        sugarLevel: item.sugarLevel,
        itemNote: item.itemNote || null,
        serviceFee,
        driverFee,
        totalItemPrice
      };
    });
    const baseTotal = items.reduce((s,i)=>s + i.basePrice * i.quantity,0);
    const serviceTotal = items.reduce((s,i)=>s + i.serviceFee * i.quantity,0);
    const driverTotal = 0;
    const totalCustomerPrice = baseTotal + serviceTotal + driverTotal;

    const note = orderNote.value.trim() || null;

    const orderData = {
      customerId: currentUser.uid,
      storeId: selectedStore.id,
      driverId: null,
      items,
      baseTotal,
      serviceTotal,
      driverTotal,
      totalCustomerPrice,
      carNumber: car,
      customerLocation: customerGeo,
      note,
      status: 'pending',
      platformCommissionSettled: false,
      driverPaid: false,
      storePaidOut: false,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };
    try{
      await db.collection('orders').add(orderData);
      orderMsg.style.color='#4ade80';
      orderMsg.textContent='ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ ØªØ§Ø¨Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø§Ù„Ø£Ø³ÙÙ„.';
      btnPlaceOrder.disabled = true;
      cartItems = [];
      updateCartUI();
    }catch(e){
      orderMsg.style.color='#f97373';
      orderMsg.textContent='Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨.';
    }
  };

  // 8) Ù…ØªØ§Ø¨Ø¹Ø© Ø¢Ø®Ø± Ø·Ù„Ø¨ Ù„Ù„Ø¹Ù…ÙŠÙ„
  function listenLastOrder(){
    if(!currentUser) return;
    db.collection('orders')
      .where('customerId','==',currentUser.uid)
      .orderBy('createdAt','desc').limit(1)
      .onSnapshot(snap=>{
        lastOrder = null;
        snap.forEach(doc=>{
          lastOrder = doc.data();
        });
        renderLastOrder();
      });
  }

  function renderLastOrder(){
    if(!lastOrder){
      statusCard.style.display='none';
      return;
    }
    statusCard.style.display='block';
    const drinkName = lastOrder.drinkName || (lastOrder.items && lastOrder.items[0]?.drinkName) || '';
    const price = lastOrder.totalCustomerPrice || lastOrder.items?.[0]?.totalItemPrice || '';
    lastOrderInfo.textContent = `${drinkName || 'Ø·Ù„Ø¨ Ù‚Ù‡ÙˆØ©'} â€¢ ${price} Ø¬ â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${lastOrder.status}`;
    const st = lastOrder.status;
    dotPending.classList.toggle('active', ['pending','accepted','preparing','ready','on_the_way','delivered'].includes(st));
    dotPreparing.classList.toggle('active', ['preparing','ready','on_the_way','delivered'].includes(st));
    dotReady.classList.toggle('active', ['ready','on_the_way','delivered'].includes(st));
    dotDelivered.classList.toggle('active', ['delivered'].includes(st));

    if(st === 'ready' || st === 'on_the_way'){
      btnOpenDirections.style.display='block';
      btnOpenDirections.onclick = ()=>{
        if(!selectedStore || !selectedStore.location){
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙƒØ§ÙÙŠØ© Ù„Ù„Ù…Ø­Ù„.');
          return;
        }
        openDirectionsToStore(selectedStore);
      };
    }else{
      btnOpenDirections.style.display='none';
    }
  }
</script>
</body>
</html>
